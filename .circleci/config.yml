version: 2.1

executors:
  php-executor:
    docker:
      - image: cimg/php:<<parameters.php-version>>-node
      - image: redis:6.2
      - image: circleci/mysql:8.0.3
    parameters:
      php-version:
        type: string
        default: "8.0"
    working_directory: ~/laravel-super-cache-invalidate

jobs:
  test:
    parameters:
      php-version:
        type: string
      laravel-version:
        type: string
    executor:
      name: php-executor
      php-version: <<parameters.php-version>>
    steps:
      - checkout

      - run:
          name: Update Composer
          command: sudo composer self-update

      - run:
          name: Install Dependencies
          command: |
            sudo composer require "laravel/framework:^10.0" --no-update
            sudo composer install --prefer-dist --no-interaction --ignore-platform-req=ext-redis

      - run:
          name: Run Tests
          command: |
            vendor/bin/phpunit --coverage-text

workflows:
  version: 2
  test:
    jobs:
      - test:
          name: PHP 8.2 + Laravel 10
          php-version: "8.2"
          laravel-version: "10"
      - test:
          name: PHP 8.3 + Laravel 10
          php-version: "8.3"
          laravel-version: "10"
      - test:
          name: PHP 8.4 + Laravel 10
          php-version: "8.4"
          laravel-version: "10"
